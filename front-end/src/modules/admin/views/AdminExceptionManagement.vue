<!-- views/admin/AdminExceptionManagement.vue - Template -->
<template>
  <div class="admin-exception-management">
    <div class="admin-header">
      <h1>ì œì™¸ ì„¤ì • ê´€ë¦¬</h1>
      <p>ì‚¬ìš©ìë³„/ë¶€ì„œë³„ ë³´ì•ˆ ê°ì‚¬ í•­ëª© ì œì™¸ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      <div class="admin-nav">
        <RouterLink to="/admin/training" class="nav-item">ëª¨ì˜í›ˆë ¨ ê´€ë¦¬</RouterLink>
        <RouterLink to="/admin/manual-check" class="nav-item">ìˆ˜ì‹œ ì ê²€ ê´€ë¦¬</RouterLink>
        <RouterLink to="/admin/exceptions" class="nav-item active">ì œì™¸ ì„¤ì •</RouterLink>
      </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tabs-container">
      <div class="tabs-header">
        <button
          @click="activeTab = 'user'"
          class="tab-button"
          :class="{ active: activeTab === 'user' }"
        >
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path
              d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"
            />
          </svg>
          ì‚¬ìš©ìë³„ ì œì™¸ ì„¤ì •
          <span class="tab-count">{{ userExceptions.length }}ê°œ</span>
        </button>

        <button
          @click="activeTab = 'department'"
          class="tab-button"
          :class="{ active: activeTab === 'department' }"
        >
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path
              d="m8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.629 13.09a1 1 0 0 1-.629-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"
            />
          </svg>
          ë¶€ì„œë³„ ì œì™¸ ì„¤ì •
          <span class="tab-count">{{ departmentExceptions.length }}ê°œ</span>
        </button>

        <button
          @click="activeTab = 'summary'"
          class="tab-button"
          :class="{ active: activeTab === 'summary' }"
        >
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path
              d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"
            />
          </svg>
          ìš”ì•½ í†µê³„
        </button>
      </div>
    </div>

    <!-- ì•¡ì…˜ ë°” - ê²€ìƒ‰ ê¸°ëŠ¥ ê°œì„  -->
    <div v-if="activeTab !== 'summary'" class="action-bar">
      <div class="filters">
        <div class="search-group">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="search-icon">
            <path
              d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"
            />
          </svg>
          <input
            type="text"
            placeholder="ì‚¬ìš©ìëª…, ID, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..."
            v-model="searchQuery"
            class="search-input"
          />
        </div>

        <select v-model="filterDepartment" class="filter-select">
          <option value="">ëª¨ë“  ë¶€ì„œ</option>
          <option v-for="dept in departments" :key="dept" :value="dept">{{ dept }}</option>
        </select>

        <select v-model="filterCategory" class="filter-select">
          <option value="">ëª¨ë“  ì¹´í…Œê³ ë¦¬</option>
          <option value="ì •ë³´ë³´ì•ˆ ê°ì‚¬">ì •ë³´ë³´ì•ˆ ê°ì‚¬</option>
          <option value="ì •ë³´ë³´í˜¸ êµìœ¡">ì •ë³´ë³´í˜¸ êµìœ¡</option>
          <option value="ì•…ì„±ë©”ì¼ ëª¨ì˜í›ˆë ¨">ì•…ì„±ë©”ì¼ ëª¨ì˜í›ˆë ¨</option>
        </select>
      </div>

      <div class="action-buttons">
        <button @click="showAddModal = true" class="primary-button">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path
              d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2z"
            />
          </svg>
          ì œì™¸ ì„¤ì • ì¶”ê°€
        </button>

        <button @click="handleExport('csv')" class="secondary-button">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path
              d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"
            />
            <path
              d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"
            />
          </svg>
          CSV ë‚´ë³´ë‚´ê¸°
        </button>
      </div>
    </div>

    <!-- ì»¨í…ì¸  ì˜ì—­ -->
    <div class="content-area">
      <!-- ë¡œë”© ìƒíƒœ -->
      <div v-if="loading" class="loading-state">
        <div class="loading-spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <!-- ì‚¬ìš©ìë³„ ì œì™¸ ì„¤ì • í…Œì´ë¸” -->
      <div v-else-if="activeTab === 'user'" class="table-container">
        <table class="exception-table">
          <thead>
            <tr>
              <th>ì‚¬ìš©ì</th>
              <th>ë¶€ì„œ</th>
              <th>ì ê²€ í•­ëª©</th>
              <th>ì œì™¸ ì‚¬ìœ </th>
              <th>ì œì™¸ ìœ í˜•</th>
              <th>ê¸°ê°„</th>
              <th>ìƒì„±ì</th>
              <th>ì•¡ì…˜</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="filteredUserExceptions.length === 0">
              <td colspan="8" class="no-data">ì‚¬ìš©ìë³„ ì œì™¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            <tr
              v-for="exc in filteredUserExceptions"
              :key="`${exc.user_id}-${exc.item_id}`"
              class="table-row"
            >
              <td>
                <div class="user-info">
                  <div class="user-name">{{ exc.username }}</div>
                  <div class="user-id">{{ exc.user_login_id }}</div>
                </div>
              </td>
              <td>{{ exc.department }}</td>
              <td>
                <div class="item-info">
                  <div class="item-name">{{ exc.item_name }}</div>
                  <div class="item-category">{{ exc.category }}</div>
                </div>
              </td>
              <td>
                <div class="exclude-reason" :title="exc.exclude_reason">
                  {{ truncateText(exc.exclude_reason, 50) }}
                </div>
              </td>
              <td>
                <div class="exclude-type" :class="exc.exclude_type">
                  <span class="type-icon">
                    {{ exc.exclude_type === 'permanent' ? 'ğŸ”’' : 'â°' }}
                  </span>
                  {{ exc.exclude_type === 'permanent' ? 'ì˜êµ¬' : 'ì„ì‹œ' }}
                </div>
              </td>
              <td>
                {{
                  exc.exclude_type === 'temporary' && exc.start_date && exc.end_date
                    ? `${exc.start_date} ~ ${exc.end_date}`
                    : '-'
                }}
              </td>
              <td>{{ exc.created_by }}</td>
              <td>
                <div class="action-buttons">
                  <button
                    @click="handleDeleteException('user', exc.user_id, exc.item_id)"
                    class="delete-button"
                    title="ì‚­ì œ"
                  >
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"
                      />
                      <path
                        fill-rule="evenodd"
                        d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"
                      />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ë¶€ì„œë³„ ì œì™¸ ì„¤ì • í…Œì´ë¸” -->
      <div v-else-if="activeTab === 'department'" class="table-container">
        <table class="exception-table">
          <thead>
            <tr>
              <th>ë¶€ì„œ</th>
              <th>ì ê²€ í•­ëª©</th>
              <th>ì œì™¸ ì‚¬ìœ </th>
              <th>ì œì™¸ ìœ í˜•</th>
              <th>ê¸°ê°„</th>
              <th>ì˜í–¥ë°›ëŠ” ì‚¬ìš©ì</th>
              <th>ìƒì„±ì</th>
              <th>ì•¡ì…˜</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="filteredDepartmentExceptions.length === 0">
              <td colspan="8" class="no-data">ë¶€ì„œë³„ ì œì™¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            <tr
              v-for="exc in filteredDepartmentExceptions"
              :key="`${exc.department}-${exc.item_id}`"
              class="table-row"
            >
              <td class="department-name">{{ exc.department }}</td>
              <td>
                <div class="item-info">
                  <div class="item-name">{{ exc.item_name }}</div>
                  <div class="item-category">{{ exc.category }}</div>
                </div>
              </td>
              <td>
                <div class="exclude-reason" :title="exc.exclude_reason">
                  {{ truncateText(exc.exclude_reason, 50) }}
                </div>
              </td>
              <td>
                <div class="exclude-type" :class="exc.exclude_type">
                  <span class="type-icon">
                    {{ exc.exclude_type === 'permanent' ? 'ğŸ”’' : 'â°' }}
                  </span>
                  {{ exc.exclude_type === 'permanent' ? 'ì˜êµ¬' : 'ì„ì‹œ' }}
                </div>
              </td>
              <td>
                {{
                  exc.exclude_type === 'temporary' && exc.start_date && exc.end_date
                    ? `${exc.start_date} ~ ${exc.end_date}`
                    : '-'
                }}
              </td>
              <td>
                <span class="affected-users">{{ exc.affected_users }}ëª…</span>
              </td>
              <td>{{ exc.created_by }}</td>
              <td>
                <div class="action-buttons">
                  <button
                    @click="handleDeleteException('department', exc.department, exc.item_id)"
                    class="delete-button"
                    title="ì‚­ì œ"
                  >
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"
                      />
                      <path
                        fill-rule="evenodd"
                        d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"
                      />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ìš”ì•½ í†µê³„ -->
      <div v-else-if="activeTab === 'summary' && summary" class="summary-container">
        <div class="summary-grid">
          <!-- ì‚¬ìš©ìë³„ ì œì™¸ ì„¤ì • í†µê³„ -->
          <div class="summary-card user-stats">
            <h3>ì‚¬ìš©ìë³„ ì œì™¸ ì„¤ì •</h3>
            <div class="stats-list">
              <div class="stat-item">
                <span class="stat-label">ì´ ì„¤ì • ìˆ˜:</span>
                <span class="stat-value">{{
                  summary.user_exceptions?.total_user_exceptions || 0
                }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ì˜êµ¬ ì œì™¸:</span>
                <span class="stat-value">{{
                  summary.user_exceptions?.permanent_user_exceptions || 0
                }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ì„ì‹œ ì œì™¸:</span>
                <span class="stat-value">{{
                  summary.user_exceptions?.temporary_user_exceptions || 0
                }}</span>
              </div>
            </div>
          </div>

          <!-- ë¶€ì„œë³„ ì œì™¸ ì„¤ì • í†µê³„ -->
          <div class="summary-card dept-stats">
            <h3>ë¶€ì„œë³„ ì œì™¸ ì„¤ì •</h3>
            <div class="stats-list">
              <div class="stat-item">
                <span class="stat-label">ì´ ì„¤ì • ìˆ˜:</span>
                <span class="stat-value">{{
                  summary.department_exceptions?.total_dept_exceptions || 0
                }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ì˜êµ¬ ì œì™¸:</span>
                <span class="stat-value">{{
                  summary.department_exceptions?.permanent_dept_exceptions || 0
                }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ì„ì‹œ ì œì™¸:</span>
                <span class="stat-value">{{
                  summary.department_exceptions?.temporary_dept_exceptions || 0
                }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ì˜í–¥ë°›ëŠ” ë¶€ì„œ:</span>
                <span class="stat-value">{{
                  summary.department_exceptions?.affected_departments || 0
                }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ê°€ì¥ ë§ì´ ì œì™¸ëœ í•­ëª©ë“¤ -->
        <div
          v-if="summary.top_excluded_items && summary.top_excluded_items.length > 0"
          class="top-items-card"
        >
          <h3>ê°€ì¥ ë§ì´ ì œì™¸ëœ í•­ëª©</h3>
          <div class="top-items-list">
            <div v-for="(item, index) in summary.top_excluded_items" :key="index" class="top-item">
              <div class="item-info">
                <span class="item-name">{{ item.item_name }}</span>
                <span class="item-category">({{ item.category }})</span>
              </div>
              <span class="exception-count">{{ item.exception_count }}ê±´</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì œì™¸ ì„¤ì • ì¶”ê°€ ëª¨ë‹¬ - ê°œì„ ëœ ë²„ì „ -->
    <div v-if="showAddModal" class="modal-overlay" @click="closeAddModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>ì œì™¸ ì„¤ì • ì¶”ê°€</h3>
          <button @click="closeAddModal" class="close-button">Ã—</button>
        </div>

        <div class="modal-body">
          <form @submit.prevent="handleAddException" class="exception-form">
            <!-- ì œì™¸ ìœ í˜• ì„ íƒ -->
            <div class="form-group">
              <label>ì œì™¸ ìœ í˜•:</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" v-model="formData.type" value="user" />
                  <span>ì‚¬ìš©ìë³„</span>
                </label>
                <label class="radio-option">
                  <input type="radio" v-model="formData.type" value="department" />
                  <span>ë¶€ì„œë³„</span>
                </label>
              </div>
            </div>

            <!-- ì‚¬ìš©ì ê²€ìƒ‰ (ì‚¬ìš©ìë³„ì¸ ê²½ìš°) -->
            <div v-if="formData.type === 'user'" class="form-group">
              <label>ì‚¬ìš©ì ê²€ìƒ‰:</label>
              <div class="user-search-container">
                <input
                  type="text"
                  v-model="userSearchQuery"
                  @input="searchUsers"
                  placeholder="ì‚¬ìš©ìëª…, ID, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..."
                  class="form-input"
                />
                <div v-if="searchedUsers.length > 0" class="user-dropdown">
                  <div
                    v-for="user in searchedUsers"
                    :key="user.uid"
                    @click="selectUser(user)"
                    class="user-option"
                    :class="{ selected: formData.user_id === user.uid }"
                  >
                    <div class="user-info">
                      <div class="user-name">{{ user.username }}</div>
                      <div class="user-details">{{ user.user_id }} - {{ user.department }}</div>
                    </div>
                  </div>
                </div>
                <div v-if="selectedUser" class="selected-user">
                  <span
                    >ì„ íƒëœ ì‚¬ìš©ì: {{ selectedUser.username }} ({{ selectedUser.user_id }})</span
                  >
                  <button type="button" @click="clearSelectedUser" class="clear-button">Ã—</button>
                </div>
              </div>
            </div>

            <!-- ë¶€ì„œ ì„ íƒ (ë¶€ì„œë³„ì¸ ê²½ìš°) -->
            <div v-if="formData.type === 'department'" class="form-group">
              <label>ë¶€ì„œ:</label>
              <select v-model="formData.department" required class="form-select">
                <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <option v-for="dept in departments" :key="dept" :value="dept">
                  {{ dept }}
                </option>
              </select>
            </div>

            <!-- ì ê²€ í•­ëª© ì„ íƒ - ê°œì„ ëœ ë²„ì „ -->
            <div class="form-group">
              <label>ì ê²€ ì¹´í…Œê³ ë¦¬:</label>
              <select
                v-model="formData.item_category"
                @change="onCategoryChange"
                required
                class="form-select"
              >
                <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì •ë³´ë³´ì•ˆ ê°ì‚¬">ì •ë³´ë³´ì•ˆ ê°ì‚¬</option>
                <option value="ì •ë³´ë³´í˜¸ êµìœ¡">ì •ë³´ë³´í˜¸ êµìœ¡</option>
                <option value="ì•…ì„±ë©”ì¼ ëª¨ì˜í›ˆë ¨">ì•…ì„±ë©”ì¼ ëª¨ì˜í›ˆë ¨</option>
              </select>
            </div>

            <!-- ì„¸ë¶€ í•­ëª© ì„ íƒ -->
            <div v-if="formData.item_category" class="form-group">
              <label>ì„¸ë¶€ í•­ëª©:</label>
              <select v-model="formData.item_type" required class="form-select">
                <option value="">í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>

                <!-- ì •ë³´ë³´ì•ˆ ê°ì‚¬ í•­ëª© -->
                <optgroup
                  v-if="formData.item_category === 'ì •ë³´ë³´ì•ˆ ê°ì‚¬'"
                  v-for="category in auditItemCategories"
                  :key="category.name"
                  :label="category.name"
                >
                  <option
                    v-for="item in category.items"
                    :key="item.item_id"
                    :value="'audit_' + item.item_id"
                    :data-name="item.item_name"
                  >
                    {{ item.item_name }} ({{ item.check_type === 'daily' ? 'ì •ê¸°' : 'ìˆ˜ì‹œ' }})
                  </option>
                </optgroup>

                <!-- ì •ë³´ë³´í˜¸ êµìœ¡ í•­ëª© (ì—°ë„ë³„) -->
                <optgroup
                  v-if="formData.item_category === 'ì •ë³´ë³´í˜¸ êµìœ¡'"
                  v-for="(items, year) in educationItems"
                  :key="year"
                  :label="year + 'ë…„'"
                >
                  <option
                    v-for="item in items"
                    :key="item.item_type"
                    :value="item.item_type"
                    :data-name="item.item_name"
                  >
                    {{ item.item_name }}
                  </option>
                </optgroup>

                <!-- ì•…ì„±ë©”ì¼ ëª¨ì˜í›ˆë ¨ í•­ëª© (ì—°ë„ë³„) -->
                <optgroup
                  v-if="formData.item_category === 'ì•…ì„±ë©”ì¼ ëª¨ì˜í›ˆë ¨'"
                  v-for="(items, year) in trainingItems"
                  :key="year"
                  :label="year + 'ë…„'"
                >
                  <option
                    v-for="item in items"
                    :key="item.item_type"
                    :value="item.item_type"
                    :data-name="item.item_name"
                  >
                    {{ item.item_name }}
                  </option>
                </optgroup>
              </select>
            </div>

            <!-- ë‚˜ë¨¸ì§€ í¼ í•„ë“œë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼ -->
            <div class="form-group">
              <label>ì œì™¸ ì‚¬ìœ :</label>
              <textarea
                v-model="formData.exclude_reason"
                required
                class="form-textarea"
                rows="3"
                placeholder="ì œì™¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
              ></textarea>
            </div>

            <!-- ì œì™¸ ê¸°ê°„ ìœ í˜• -->
            <div class="form-group">
              <label>ì œì™¸ ê¸°ê°„:</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" v-model="formData.exclude_type" value="permanent" />
                  <span>ì˜êµ¬ ì œì™¸</span>
                </label>
                <label class="radio-option">
                  <input type="radio" v-model="formData.exclude_type" value="temporary" />
                  <span>ì„ì‹œ ì œì™¸</span>
                </label>
              </div>
            </div>

            <!-- ì„ì‹œ ì œì™¸ ê¸°ê°„ ì„¤ì • -->
            <div v-if="formData.exclude_type === 'temporary'" class="form-row">
              <div class="form-group">
                <label>ì‹œì‘ì¼:</label>
                <input type="date" v-model="formData.start_date" required class="form-input" />
              </div>
              <div class="form-group">
                <label>ì¢…ë£Œì¼:</label>
                <input type="date" v-model="formData.end_date" required class="form-input" />
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button @click="closeAddModal" class="cancel-button">ì·¨ì†Œ</button>
          <button @click="handleAddException" :disabled="!isFormValid" class="save-button">
            ì¶”ê°€
          </button>
        </div>
      </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div v-if="showToast" :class="['toast-message', toastType]">
      {{ toastMessage }}
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { RouterLink } from 'vue-router'

// ë°˜ì‘í˜• ë°ì´í„°
const loading = ref(false)
const activeTab = ref('user')
const userExceptions = ref([])
const departmentExceptions = ref([])
const summary = ref(null)

// í¼ ë°ì´í„° - ê°œì„ ëœ ë²„ì „
const departments = ref([])
const availableItems = ref({}) // ì¹´í…Œê³ ë¦¬ë³„ í•­ëª©ë“¤
const searchedUsers = ref([]) // ê²€ìƒ‰ëœ ì‚¬ìš©ì ëª©ë¡
const selectedUser = ref(null) // ì„ íƒëœ ì‚¬ìš©ì

// ëª¨ë‹¬ ìƒíƒœ
const showAddModal = ref(false)

// í¼ ìƒíƒœ - ê°œì„ ëœ ë²„ì „
const formData = ref({
  type: 'user',
  user_id: '',
  department: '',
  item_category: '', // ìƒˆë¡œ ì¶”ê°€: ì¹´í…Œê³ ë¦¬ ì„ íƒ
  item_type: '', // ë³€ê²½: item_idì—ì„œ item_typeìœ¼ë¡œ
  item_name: '', // ìƒˆë¡œ ì¶”ê°€: í•­ëª©ëª… ì €ì¥
  exclude_reason: '',
  exclude_type: 'permanent',
  start_date: '',
  end_date: '',
})

// ê²€ìƒ‰ ê´€ë ¨
const userSearchQuery = ref('')
const searchQuery = ref('')
const filterDepartment = ref('')
const filterCategory = ref('') // ìƒˆë¡œ ì¶”ê°€: ì¹´í…Œê³ ë¦¬ í•„í„°

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€
const showToast = ref(false)
const toastMessage = ref('')
const toastType = ref('success')

// ê³„ì‚°ëœ ì†ì„± - ê°œì„ ëœ ë²„ì „
const auditItemCategories = computed(() => {
  const auditItems = availableItems.value['ì •ë³´ë³´ì•ˆ ê°ì‚¬'] || []
  const groups = {}

  auditItems.forEach((item) => {
    if (!groups[item.category]) {
      groups[item.category] = {
        name: item.category,
        items: [],
      }
    }
    groups[item.category].items.push(item)
  })

  return Object.values(groups)
})

// computed ì„¹ì…˜ì— ì¶”ê°€
const educationItems = computed(() => {
  const baseItems = availableItems.value['ì •ë³´ë³´í˜¸ êµìœ¡'] || []
  // ì—°ë„ë³„ë¡œ ê·¸ë£¹í™”
  const groupedByYear = {}

  baseItems.forEach((item) => {
    const year = item.year || new Date().getFullYear()
    if (!groupedByYear[year]) {
      groupedByYear[year] = []
    }
    groupedByYear[year].push(item)
  })

  return groupedByYear
})

const trainingItems = computed(() => {
  const baseItems = availableItems.value['ì•…ì„±ë©”ì¼ ëª¨ì˜í›ˆë ¨'] || []
  // ì—°ë„ë³„ë¡œ ê·¸ë£¹í™”
  const groupedByYear = {}

  baseItems.forEach((item) => {
    const year = item.year || new Date().getFullYear()
    if (!groupedByYear[year]) {
      groupedByYear[year] = []
    }
    groupedByYear[year].push(item)
  })

  return groupedByYear
})

const filteredUserExceptions = computed(() => {
  return userExceptions.value.filter((exc) => {
    const matchesSearch =
      !searchQuery.value ||
      exc.username.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
      exc.user_login_id.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
      exc.item_name.toLowerCase().includes(searchQuery.value.toLowerCase())

    const matchesDept = !filterDepartment.value || exc.department === filterDepartment.value
    const matchesCategory = !filterCategory.value || exc.item_category === filterCategory.value

    return matchesSearch && matchesDept && matchesCategory
  })
})

const filteredDepartmentExceptions = computed(() => {
  return departmentExceptions.value.filter((exc) => {
    const matchesSearch =
      !searchQuery.value ||
      exc.department.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
      exc.item_name.toLowerCase().includes(searchQuery.value.toLowerCase())

    const matchesDept = !filterDepartment.value || exc.department === filterDepartment.value
    const matchesCategory = !filterCategory.value || exc.item_category === filterCategory.value

    return matchesSearch && matchesDept && matchesCategory
  })
})

const isFormValid = computed(() => {
  const basicValid = formData.value.exclude_reason && formData.value.item_type

  if (formData.value.type === 'user') {
    return basicValid && formData.value.user_id
  } else {
    return basicValid && formData.value.department
  }
})

// ë©”ì„œë“œ - ê°œì„ ëœ ë²„ì „
const loadInitialData = async () => {
  try {
    const [deptsRes, itemsRes] = await Promise.all([
      fetch('/api/exceptions/departments', { credentials: 'include' }),
      fetch('/api/exceptions/available-items', { credentials: 'include' }),
    ])

    if (deptsRes.ok) {
      departments.value = await deptsRes.json()
    }
    if (itemsRes.ok) {
      availableItems.value = await itemsRes.json()
    }
  } catch (error) {
    showToastMessage('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error')
  }
}

const searchUsers = async () => {
  if (userSearchQuery.value.length < 2) {
    searchedUsers.value = []
    return
  }

  try {
    const response = await fetch(
      `/api/exceptions/search-users?q=${encodeURIComponent(userSearchQuery.value)}&limit=20`,
      { credentials: 'include' },
    )

    if (response.ok) {
      searchedUsers.value = await response.json()
    }
  } catch (error) {
    console.error('ì‚¬ìš©ì ê²€ìƒ‰ ì‹¤íŒ¨:', error)
  }
}

const selectUser = (user) => {
  selectedUser.value = user
  formData.value.user_id = user.uid
  userSearchQuery.value = user.username
  searchedUsers.value = []
}

const clearSelectedUser = () => {
  selectedUser.value = null
  formData.value.user_id = ''
  userSearchQuery.value = ''
  searchedUsers.value = []
}

const onCategoryChange = () => {
  // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ì„¸ë¶€ í•­ëª© ì´ˆê¸°í™”
  formData.value.item_type = ''
  formData.value.item_name = ''
}

const loadUserExceptions = async () => {
  loading.value = true
  try {
    const response = await fetch('/api/exceptions/user-exceptions', {
      credentials: 'include',
    })

    if (response.ok) {
      userExceptions.value = await response.json()
    } else {
      throw new Error('ì‚¬ìš©ì ì œì™¸ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨')
    }
  } catch (error) {
    showToastMessage('ì‚¬ìš©ì ì œì™¸ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨', 'error')
  } finally {
    loading.value = false
  }
}

const loadDepartmentExceptions = async () => {
  loading.value = true
  try {
    const response = await fetch('/api/exceptions/department-exceptions', {
      credentials: 'include',
    })

    if (response.ok) {
      departmentExceptions.value = await response.json()
    } else {
      throw new Error('ë¶€ì„œ ì œì™¸ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨')
    }
  } catch (error) {
    showToastMessage('ë¶€ì„œ ì œì™¸ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨', 'error')
  } finally {
    loading.value = false
  }
}

const loadSummary = async () => {
  loading.value = true
  try {
    const response = await fetch('/api/exceptions/summary', {
      credentials: 'include',
    })

    if (response.ok) {
      summary.value = await response.json()
    } else {
      throw new Error('ìš”ì•½ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨')
    }
  } catch (error) {
    showToastMessage('ìš”ì•½ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error')
  } finally {
    loading.value = false
  }
}

const handleAddException = async () => {
  if (!isFormValid.value) {
    showToastMessage('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error')
    return
  }

  try {
    const endpoint = formData.value.type === 'user' ? 'user-exceptions' : 'department-exceptions'
    const payload = { ...formData.value }

    // ì„ íƒëœ í•­ëª©ì˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const selectedOption = document.querySelector(
      `select option[value="${formData.value.item_type}"]`,
    )
    if (selectedOption) {
      payload.item_name = selectedOption.getAttribute('data-name') || selectedOption.textContent
    }

    // í•„ìš” ì—†ëŠ” í•„ë“œ ì œê±°
    if (formData.value.type === 'user') {
      delete payload.department
      payload.user_id = parseInt(payload.user_id)
    } else {
      delete payload.user_id
    }

    delete payload.type
    delete payload.item_category

    // ì„ì‹œ ì œì™¸ê°€ ì•„ë‹Œ ê²½ìš° ë‚ ì§œ í•„ë“œ ì œê±°
    if (payload.exclude_type !== 'temporary') {
      delete payload.start_date
      delete payload.end_date
    }

    console.log('ì œì™¸ ì„¤ì • ì¶”ê°€ ìš”ì²­:', payload) // ë””ë²„ê¹…ìš©

    const response = await fetch(`/api/exceptions/${endpoint}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify(payload),
    })

    if (response.ok) {
      const result = await response.json()
      showToastMessage(result.message || 'ì œì™¸ ì„¤ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
      closeAddModal()
      resetForm()

      // í˜„ì¬ íƒ­ì— ë”°ë¼ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
      if (activeTab.value === 'user') {
        await loadUserExceptions()
      } else if (activeTab.value === 'department') {
        await loadDepartmentExceptions()
      }
    } else {
      const error = await response.json()
      showToastMessage(error.error || 'ì¶”ê°€ ì‹¤íŒ¨', 'error')
    }
  } catch (error) {
    console.error('ì œì™¸ ì„¤ì • ì¶”ê°€ ì‹¤íŒ¨:', error)
    showToastMessage('ì œì™¸ ì„¤ì • ì¶”ê°€ ì‹¤íŒ¨: ' + error.message, 'error')
  }
}

const handleDeleteException = async (type, id1, id2) => {
  if (!confirm('ì´ ì œì™¸ ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return
  }

  try {
    const endpoint =
      type === 'user'
        ? `user-exceptions/${id1}/${id2}`
        : `department-exceptions/${encodeURIComponent(id1)}/${id2}`

    const response = await fetch(`/api/exceptions/${endpoint}`, {
      method: 'DELETE',
      credentials: 'include',
    })

    if (response.ok) {
      const result = await response.json()
      showToastMessage(result.message || 'ì œì™¸ ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')

      // í˜„ì¬ íƒ­ì— ë”°ë¼ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
      if (type === 'user') {
        await loadUserExceptions()
      } else {
        await loadDepartmentExceptions()
      }
    } else {
      const error = await response.json()
      showToastMessage(error.error || 'ì‚­ì œ ì‹¤íŒ¨', 'error')
    }
  } catch (error) {
    showToastMessage('ì œì™¸ ì„¤ì • ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error')
  }
}

const handleExport = async (format = 'json') => {
  try {
    const response = await fetch(`/api/exceptions/export?format=${format}`, {
      credentials: 'include',
    })

    if (response.ok) {
      if (format === 'csv') {
        const blob = await response.blob()
        const url = window.URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'exception_settings.csv'
        a.click()
        window.URL.revokeObjectURL(url)
      } else {
        const data = await response.json()
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: 'application/json',
        })
        const url = window.URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'exception_settings.json'
        a.click()
        window.URL.revokeObjectURL(url)
      }
      showToastMessage('ì œì™¸ ì„¤ì •ì´ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.', 'success')
    } else {
      throw new Error('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨')
    }
  } catch (error) {
    showToastMessage('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error.message, 'error')
  }
}

const closeAddModal = () => {
  showAddModal.value = false
  searchedUsers.value = []
}

const resetForm = () => {
  formData.value = {
    type: 'user',
    user_id: '',
    department: '',
    item_category: '',
    item_type: '',
    item_name: '',
    exclude_reason: '',
    exclude_type: 'permanent',
    start_date: '',
    end_date: '',
  }
  selectedUser.value = null
  userSearchQuery.value = ''
  searchedUsers.value = []
}

const truncateText = (text, maxLength) => {
  if (!text) return '-'
  return text.length > maxLength ? text.substring(0, maxLength) + '...' : text
}

const showToastMessage = (message, type = 'success') => {
  toastMessage.value = message
  toastType.value = type
  showToast.value = true

  setTimeout(() => {
    showToast.value = false
  }, 3000)
}

// ê°ì‹œì
watch(activeTab, async (newTab) => {
  if (newTab === 'user') {
    await loadUserExceptions()
  } else if (newTab === 'department') {
    await loadDepartmentExceptions()
  } else if (newTab === 'summary') {
    await loadSummary()
  }
})

// ê°ì‹œì - ê°œì„ ëœ ë²„ì „
watch(
  () => formData.value.type,
  (newType) => {
    if (newType === 'user') {
      formData.value.department = ''
    } else {
      formData.value.user_id = ''
      clearSelectedUser()
    }
  },
)

// ì œì™¸ ìœ í˜• ë³€ê²½ì‹œ ë‚ ì§œ í•„ë“œ ì´ˆê¸°í™”
watch(
  () => formData.value.exclude_type,
  (newType) => {
    if (newType === 'permanent') {
      formData.value.start_date = ''
      formData.value.end_date = ''
    }
  },
)

// ë¼ì´í”„ì‚¬ì´í´ í›…
onMounted(async () => {
  await loadInitialData()
  await loadUserExceptions()
})
</script>

<style scoped>
@import '../styles/AdminExceptionManagement.css';
</style>

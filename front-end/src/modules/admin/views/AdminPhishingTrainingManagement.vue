<template>
  <div class="admin-training">
    <!-- ===== Í¥ÄÎ¶¨ Ìó§Îçî ===== -->
    <div class="admin-header">
      <h1>ÌîºÏã± ÌõàÎ†® Í¥ÄÎ¶¨</h1>
      <div class="admin-nav">
        <RouterLink to="/admin/education" class="nav-item">ÍµêÏú° Í¥ÄÎ¶¨</RouterLink>
        <RouterLink to="/admin/phishing" class="nav-item active">ÌîºÏã± ÌõàÎ†® Í¥ÄÎ¶¨</RouterLink>
        <RouterLink to="/admin/manual-check" class="nav-item">ÏàòÏãú Ï†êÍ≤Ä Í¥ÄÎ¶¨</RouterLink>
        <RouterLink to="/admin/exceptions" class="nav-item">Ï†úÏô∏ ÏÑ§Ï†ï</RouterLink>
      </div>
    </div>

    <div class="management-content">
      <!-- ===== ÌõàÎ†® Í∏∞Í∞Ñ Í¥ÄÎ¶¨ ÏÑπÏÖò ===== -->
      <div class="period-management-section">
        <div class="section-header">
          <h3>üóìÔ∏è ÌõàÎ†® Í∏∞Í∞Ñ Í¥ÄÎ¶¨</h3>
          <button @click="openPeriodModal" class="primary-button">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path
                d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"
              />
            </svg>
            Í∏∞Í∞Ñ Ï∂îÍ∞Ä
          </button>
        </div>

        <!-- ÌõàÎ†® Í∏∞Í∞Ñ Ïπ¥ÎìúÎì§ -->
        <div
          class="period-cards"
          v-if="periodStatus.training_types && Object.keys(periodStatus.training_types).length > 0"
        >
          <div
            v-for="(typeData, trainingType) in periodStatus.training_types"
            :key="trainingType"
            class="education-type-group"
          >
            <!-- ÌõàÎ†® Ïú†Ìòï Ìó§Îçî -->
            <div class="type-header-with-stats">
              <div class="type-title-section">
                <h4 class="type-header">{{ trainingType }} ÌõàÎ†®</h4>
                <div class="type-summary">
                  <span class="stat-item"> Ï∞∏Í∞ÄÏûê {{ typeData.total_participants }}Î™Ö </span>
                  <span class="stat-item success"> ÏÑ±Í≥µ {{ typeData.total_success }}Î™Ö </span>
                  <span class="stat-item failure"> Ïã§Ìå® {{ typeData.total_failure }}Î™Ö </span>
                  <span class="stat-item" :class="getRateClass(getTypeSuccessRate(typeData))">
                    ÏÑ±Í≥µÎ•† {{ getTypeSuccessRate(typeData) }}%
                  </span>
                </div>
              </div>
            </div>

            <div class="type-periods">
              <div
                v-for="period in typeData.periods"
                :key="period.period_id"
                class="period-card"
                :class="[`status-${period.status}`, { completed: period.is_completed }]"
              >
                <!-- Ïπ¥Îìú Ìó§Îçî -->
                <div class="card-header">
                  <h5>{{ period.period_name }}</h5>
                  <div class="status-badge" :class="getCardHeaderStatusClass(period.status)">
                    {{ period.status }}
                  </div>
                </div>

                <!-- Ïπ¥Îìú Î∞îÎîî -->
                <div class="card-body">
                  <div class="period-info">
                    <div class="info-item">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path
                          d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"
                        />
                      </svg>
                      {{ formatDateRange(period.start_date, period.end_date) }}
                    </div>
                    <div class="info-item">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path
                          d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0zM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816zM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275zM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"
                        />
                      </svg>
                      Ï∞∏Í∞ÄÏûê {{ period.participants }}Î™Ö
                    </div>
                    <div class="info-item">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path
                          d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01-.622-.636zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708z"
                        />
                      </svg>
                      <span :class="getRateClass(period.success_rate)">
                        ÏÑ±Í≥µÎ•† {{ period.success_rate }}%
                      </span>
                    </div>
                  </div>

                  <!-- ÌÜµÍ≥Ñ Ï†ïÎ≥¥ -->
                  <div class="period-stats">
                    <div class="stats-grid">
                      <div class="stat-item success">
                        <span class="stat-value">{{ period.success_count }}</span>
                        <span class="stat-label">ÏÑ±Í≥µ</span>
                      </div>
                      <div class="stat-item failure">
                        <span class="stat-value">{{ period.failure_count }}</span>
                        <span class="stat-label">Ïã§Ìå®</span>
                      </div>
                    </div>
                  </div>

                  <!-- ÏÑ§Î™Ö -->
                  <div v-if="period.description" class="period-description">
                    {{ period.description }}
                  </div>
                </div>

                <!-- Ïπ¥Îìú Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
                <div class="card-actions">
                  <button
                    @click="editPeriod(period)"
                    class="edit-button"
                    :disabled="period.is_completed"
                    title="Í∏∞Í∞Ñ ÏàòÏ†ï"
                  >
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L14.5 5.207l-3-3L12.146.146zM11.207 1.5 13.5 3.793 4.793 12.5H2.5v-2.293L11.207 1.5z"
                      />
                    </svg>
                    ÏàòÏ†ï
                  </button>

                  <button
                    v-if="!period.is_completed"
                    @click="completePeriod(period)"
                    class="complete-button"
                    title="Í∏∞Í∞Ñ ÏôÑÎ£å"
                  >
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"
                      />
                    </svg>
                    ÏôÑÎ£å
                  </button>

                  <button
                    v-else
                    @click="reopenPeriod(period)"
                    class="reopen-button"
                    title="Í∏∞Í∞Ñ Ïû¨Í∞ú"
                  >
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                      <path
                        d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"
                      />
                    </svg>
                    Ïû¨Í∞ú
                  </button>

                  <button
                    @click="deletePeriod(period)"
                    class="delete-button"
                    :disabled="period.participants > 0"
                    title="Í∏∞Í∞Ñ ÏÇ≠Ï†ú"
                  >
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"
                      />
                      <path
                        fill-rule="evenodd"
                        d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"
                      />
                    </svg>
                    ÏÇ≠Ï†ú
                  </button>

                  <button @click="viewDetailStats(period)" class="stats-button" title="ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm-5 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3z"
                      />
                    </svg>
                    ÌÜµÍ≥Ñ
                  </button>

                  <button
                    @click="openUploadModal(period)"
                    class="upload-button"
                    title="Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú"
                  >
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"
                      />
                      <path
                        d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"
                      />
                    </svg>
                    ÏóÖÎ°úÎìú
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ÎπÑÏñ¥ÏûàÏùÑ Îïå ÌëúÏãú -->
        <div v-else class="empty-state">
          <div class="empty-icon">
            <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
              <path
                d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"
              />
            </svg>
          </div>
          <h3>Îì±Î°ùÎêú ÌõàÎ†® Í∏∞Í∞ÑÏù¥ ÏóÜÏäµÎãàÎã§</h3>
          <p>ÏÉàÎ°úÏö¥ ÌîºÏã± ÌõàÎ†® Í∏∞Í∞ÑÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî.</p>
          <button @click="openPeriodModal" class="primary-button">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path
                d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"
              />
            </svg>
            Ï≤´ Î≤àÏß∏ Í∏∞Í∞Ñ Ï∂îÍ∞Ä
          </button>
        </div>
      </div>

      <!-- ===== ÌõàÎ†® Í∏∞Î°ù Í¥ÄÎ¶¨ ÏÑπÏÖò ===== -->
      <div class="table-section">
        <!-- Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
        <div class="section-header">
          <h3>üìã ÌõàÎ†® Í∏∞Î°ù Í¥ÄÎ¶¨ ({{ filteredRecords.length }}Í±¥)</h3>
          <div class="section-actions">
            <button @click="downloadTemplate" class="outline-button">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                  d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"
                />
              </svg>
              üìÑ ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú
            </button>
            <button @click="showBulkUploadModal = true" class="primary-button">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                  d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"
                />
                <path
                  d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"
                />
              </svg>
              üì§ ÏùºÍ¥Ñ Îì±Î°ù
            </button>
          </div>
        </div>

        <!-- ÌïÑÌÑ∞ ÏÑπÏÖò -->
        <div class="filter-section">
          <div class="filter-group">
            <label>Ïó∞ÎèÑ:</label>
            <select v-model="selectedYear" @change="loadTrainingData">
              <option v-for="year in availableYears" :key="year" :value="year">{{ year }}ÎÖÑ</option>
            </select>
          </div>

          <div class="filter-group">
            <label>ÌõàÎ†®Ïú†Ìòï:</label>
            <select v-model="selectedTrainingType" @change="loadTrainingData">
              <option value="">Ï†ÑÏ≤¥</option>
              <option value="Ïù¥Î©îÏùº ÌîºÏã±">Ïù¥Î©îÏùº ÌîºÏã±</option>
              <option value="SMS ÌîºÏã±">SMS ÌîºÏã±</option>
              <option value="Ï†ÑÌôî ÌîºÏã±">Ï†ÑÌôî ÌîºÏã±</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Í≤∞Í≥º:</label>
            <select v-model="selectedResult" @change="loadTrainingData">
              <option value="">Ï†ÑÏ≤¥</option>
              <option value="success">ÏÑ±Í≥µ</option>
              <option value="fail">Ïã§Ìå®</option>
              <option value="no_response">Î¨¥ÏùëÎãµ</option>
            </select>
          </div>

          <div class="search-group">
            <label>Í≤ÄÏÉâ:</label>
            <input
              type="text"
              v-model="searchQuery"
              @input="searchTrainingData"
              placeholder="ÏÇ¨Ïö©ÏûêÎ™Ö ÎòêÎäî Î∂ÄÏÑú Í≤ÄÏÉâ..."
              class="search-input"
            />
          </div>
        </div>

        <!-- Í∏∞Î°ù ÌÖåÏù¥Î∏îÏùÄ Îã§Ïùå Îã®Í≥ÑÏóêÏÑú Íµ¨ÌòÑ -->
        <div class="records-table-placeholder">
          <p>ÌõàÎ†® Í∏∞Î°ù ÌÖåÏù¥Î∏îÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</p>
        </div>
      </div>
    </div>

    <!-- Î™®Îã¨Îì§ÏùÄ Îã§Ïùå Îã®Í≥ÑÏóêÏÑú Íµ¨ÌòÑ -->
    <!-- Í∏∞Í∞Ñ ÏÉùÏÑ±/ÏàòÏ†ï Î™®Îã¨ -->
    <div v-if="showPeriodModal" class="modal-overlay" @click="closePeriodModal">
      <div class="modal-content period-modal" @click.stop>
        <div class="modal-header">
          <h3>
            {{ editingPeriod ? 'ÌõàÎ†® Í∏∞Í∞Ñ ÏàòÏ†ï' : 'ÏÉà ÌõàÎ†® Í∏∞Í∞Ñ Ï∂îÍ∞Ä' }}
          </h3>
          <button @click="closePeriodModal" class="close-button">&times;</button>
        </div>

        <div class="modal-body">
          <form @submit.prevent="savePeriod">
            <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑπÏÖò -->
            <div class="form-section">
              <h4>Í∏∞Î≥∏ Ï†ïÎ≥¥</h4>

              <div class="form-grid">
                <div class="form-group">
                  <label for="training-year">ÌõàÎ†® Ïó∞ÎèÑ *</label>
                  <select
                    id="training-year"
                    v-model="periodForm.training_year"
                    class="form-control"
                    required
                    :disabled="editingPeriod"
                  >
                    <option v-for="year in availableYears" :key="year" :value="year">
                      {{ year }}ÎÖÑ
                    </option>
                  </select>
                  <small class="form-hint" v-if="editingPeriod">
                    Í∏∞Ï°¥ Í∏∞Í∞ÑÏùò Ïó∞ÎèÑÎäî ÏàòÏ†ïÌï† Ïàò ÏóÜÏäµÎãàÎã§.
                  </small>
                </div>

                <div class="form-group">
                  <label for="training-type">ÌõàÎ†® Ïú†Ìòï *</label>
                  <select
                    id="training-type"
                    v-model="periodForm.training_type"
                    class="form-control"
                    required
                  >
                    <option value="Ïù¥Î©îÏùº ÌîºÏã±">Ïù¥Î©îÏùº ÌîºÏã±</option>
                    <option value="SMS ÌîºÏã±">SMS ÌîºÏã±</option>
                    <option value="Ï†ÑÌôî ÌîºÏã±">Ï†ÑÌôî ÌîºÏã±</option>
                    <option value="ÏõπÏÇ¨Ïù¥Ìä∏ ÌîºÏã±">ÏõπÏÇ¨Ïù¥Ìä∏ ÌîºÏã±</option>
                    <option value="ÏÜåÏÖú ÏóîÏßÄÎãàÏñ¥ÎßÅ">ÏÜåÏÖú ÏóîÏßÄÎãàÏñ¥ÎßÅ</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="period-name">Í∏∞Í∞ÑÎ™Ö *</label>
                <input
                  id="period-name"
                  v-model="periodForm.period_name"
                  type="text"
                  class="form-control"
                  placeholder="Ïòà: 1Ï∞® Ïù¥Î©îÏùº ÌîºÏã± ÌõàÎ†®"
                  required
                  maxlength="50"
                />
                <small class="form-hint">
                  ÌõàÎ†® Í∏∞Í∞ÑÏùÑ Íµ¨Î∂ÑÌï† Ïàò ÏûàÎäî Î™ÖÌôïÌïú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî. (ÏµúÎåÄ 50Ïûê)
                </small>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="start-date">ÏãúÏûëÏùº *</label>
                  <input
                    id="start-date"
                    v-model="periodForm.start_date"
                    type="date"
                    class="form-control"
                    required
                    :min="getMinDate()"
                  />
                </div>

                <div class="form-group">
                  <label for="end-date">Ï¢ÖÎ£åÏùº *</label>
                  <input
                    id="end-date"
                    v-model="periodForm.end_date"
                    type="date"
                    class="form-control"
                    required
                    :min="periodForm.start_date || getMinDate()"
                  />
                </div>
              </div>

              <!-- ÎÇ†Ïßú Ïú†Ìö®ÏÑ± Ï≤¥ÌÅ¨ Î©îÏãúÏßÄ -->
              <div v-if="dateValidationMessage" class="validation-message">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path
                    d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"
                  />
                </svg>
                {{ dateValidationMessage }}
              </div>

              <div class="form-group">
                <label for="description">ÏÑ§Î™Ö</label>
                <textarea
                  id="description"
                  v-model="periodForm.description"
                  class="form-control"
                  rows="3"
                  placeholder="ÌõàÎ†®Ïóê ÎåÄÌïú Í∞ÑÎã®Ìïú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                  maxlength="500"
                ></textarea>
                <small class="form-hint">
                  {{ periodForm.description ? periodForm.description.length : 0 }}/500Ïûê
                </small>
              </div>
            </div>

            <!-- ÌõàÎ†® ÏÑ§Ï†ï ÏÑπÏÖò -->
            <div class="form-section">
              <h4>ÌõàÎ†® ÏÑ§Ï†ï</h4>

              <div class="form-group">
                <div class="checkbox-group">
                  <input
                    id="auto-pass"
                    v-model="periodForm.auto_pass_setting"
                    type="checkbox"
                    class="form-checkbox"
                  />
                  <label for="auto-pass" class="checkbox-label">
                    ÏûêÎèô ÌÜµÍ≥º Ï≤òÎ¶¨ ÏÑ§Ï†ï
                    <span class="tooltip-trigger">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path
                          d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
                        />
                        <path
                          d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"
                        />
                      </svg>
                      <span class="tooltip-content">
                        Í∏∞Í∞Ñ ÏôÑÎ£å Ïãú Î¨¥ÏùëÎãµ ÏÇ¨Ïö©ÏûêÎ•º ÏûêÎèôÏúºÎ°ú ÏÑ±Í≥µ Ï≤òÎ¶¨Ìï©ÎãàÎã§.
                      </span>
                    </span>
                  </label>
                </div>
                <small class="form-hint">
                  Ï≤¥ÌÅ¨ÌïòÎ©¥ ÌõàÎ†® Í∏∞Í∞Ñ ÏôÑÎ£å Ïãú Î¨¥ÏùëÎãµÌïú ÏÇ¨Ïö©ÏûêÎì§ÏùÑ ÏûêÎèôÏúºÎ°ú ÏÑ±Í≥µ Ï≤òÎ¶¨Ìï©ÎãàÎã§.
                </small>
              </div>
            </div>

            <!-- Ï§ëÎ≥µ Ï≤¥ÌÅ¨ ÏïàÎÇ¥ -->
            <div v-if="duplicateWarning" class="warning-section">
              <div class="warning-message">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path
                    d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"
                  />
                </svg>
                {{ duplicateWarning }}
              </div>
            </div>

            <!-- Í∏∞Ï°¥ Í∏∞Í∞Ñ ÏàòÏ†ï Ïãú Ï∂îÍ∞Ä ÏïàÎÇ¥ -->
            <div v-if="editingPeriod && editingPeriod.is_completed" class="info-section">
              <div class="info-message">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path
                    d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"
                  />
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                </svg>
                ÏôÑÎ£åÎêú ÌõàÎ†® Í∏∞Í∞ÑÏûÖÎãàÎã§. ÏàòÏ†ïÌïòÎ†§Î©¥ Î®ºÏ†Ä Í∏∞Í∞ÑÏùÑ Ïû¨Í∞úÌï¥Ïïº Ìï©ÎãàÎã§.
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" @click="closePeriodModal" class="cancel-button">Ï∑®ÏÜå</button>
              <button type="submit" class="save-button" :disabled="!isValidPeriodForm || saving">
                <svg
                  v-if="saving"
                  width="16"
                  height="16"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                  class="animate-spin"
                >
                  <path
                    d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"
                  />
                  <path
                    fill-rule="evenodd"
                    d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"
                  />
                </svg>
                <svg v-else width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path
                    d="M15.854 8.354a.5.5 0 0 0 0-.708L13.207 5a.5.5 0 0 0-.707.707L14.793 7.5H1a.5.5 0 0 0 0 1h13.793L12.5 10.793a.5.5 0 0 0 .707.707l2.647-2.646z"
                  />
                </svg>
                {{ saving ? 'Ï†ÄÏû• Ï§ë...' : editingPeriod ? 'ÏàòÏ†ï' : 'ÏÉùÏÑ±' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- ÌîºÏã± ÌõàÎ†® ÏóÖÎ°úÎìú Î™®Îã¨ - AdminPhishingTrainingManagement.vueÏóê Ï∂îÍ∞ÄÌï† Î∂ÄÎ∂Ñ -->

    <!-- ÏùºÍ¥Ñ ÏóÖÎ°úÎìú Î™®Îã¨ -->
    <div v-if="showBulkUploadModal" class="modal-overlay" @click="closeBulkUploadModal">
      <div class="modal-content bulk-upload-modal" @click.stop>
        <div class="modal-header">
          <h3>ÌîºÏã± ÌõàÎ†® Í≤∞Í≥º ÏùºÍ¥Ñ ÏóÖÎ°úÎìú</h3>
          <button @click="closeBulkUploadModal" class="close-button">&times;</button>
        </div>

        <div class="modal-body">
          <!-- 1Îã®Í≥Ñ: ÌõàÎ†® Í∏∞Í∞Ñ ÏÑ†ÌÉù -->
          <div class="upload-step" :class="{ disabled: !selectedUploadPeriod }">
            <h4>1Îã®Í≥Ñ: ÌõàÎ†® Í∏∞Í∞Ñ ÏÑ†ÌÉù (ÌïÑÏàò)</h4>
            <div class="period-selection">
              <select v-model="selectedUploadPeriod" @change="onPeriodChange" class="period-select">
                <option value="">ÌõàÎ†® Í∏∞Í∞ÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                <optgroup
                  v-for="(typeData, trainingType) in availablePeriodsForUpload"
                  :key="trainingType"
                  :label="`${trainingType} ÌõàÎ†®`"
                >
                  <option
                    v-for="period in typeData.periods"
                    :key="period.period_id"
                    :value="period.period_id"
                    :disabled="period.is_completed"
                  >
                    {{ period.period_name }} ({{
                      formatDateRange(period.start_date, period.end_date)
                    }}) - {{ getPeriodStatusText(period) }}
                  </option>
                </optgroup>
              </select>
            </div>

            <!-- ÏÑ†ÌÉùÎêú Í∏∞Í∞Ñ Ï†ïÎ≥¥ ÌëúÏãú -->
            <div v-if="selectedPeriodInfo" class="selected-period-info">
              <div class="info-card">
                <h5>ÏÑ†ÌÉùÎêú ÌõàÎ†® Í∏∞Í∞Ñ</h5>
                <p><strong>Í∏∞Í∞ÑÎ™Ö:</strong> {{ selectedPeriodInfo.period_name }}</p>
                <p><strong>ÌõàÎ†® Ïú†Ìòï:</strong> {{ selectedPeriodInfo.training_type }}</p>
                <p>
                  <strong>ÌõàÎ†® Í∏∞Í∞Ñ:</strong>
                  {{ formatDateRange(selectedPeriodInfo.start_date, selectedPeriodInfo.end_date) }}
                </p>
                <p><strong>ÏÉÅÌÉú:</strong> {{ getPeriodStatusText(selectedPeriodInfo) }}</p>
                <p v-if="selectedPeriodInfo.description">
                  <strong>ÏÑ§Î™Ö:</strong> {{ selectedPeriodInfo.description }}
                </p>
              </div>
            </div>

            <!-- Í∏∞Í∞Ñ ÎØ∏ÏÑ†ÌÉù ÏïàÎÇ¥ -->
            <div v-if="!selectedUploadPeriod" class="warning-message">
              <p>‚ö†Ô∏è Î®ºÏ†Ä ÌõàÎ†® Í∏∞Í∞ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p>
            </div>
          </div>

          <!-- 2Îã®Í≥Ñ: ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú -->
          <div class="upload-step">
            <h4>2Îã®Í≥Ñ: ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú</h4>
            <p>ÌîºÏã± ÌõàÎ†® Í≤∞Í≥ºÎ•º Ï†ïÌôïÌûà ÏóÖÎ°úÎìúÌïòÎ†§Î©¥ ÏïÑÎûò ÌÖúÌîåÎ¶øÏùÑ Îã§Ïö¥Î°úÎìúÌïòÏó¨ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.</p>

            <div class="template-section">
              <button @click="downloadTemplate" class="template-btn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path
                    d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"
                  />
                  <path
                    d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"
                  />
                </svg>
                ÏóëÏÖÄ ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú
              </button>
            </div>

            <!-- ÌïÑÏàò Ïª¨Îüº ÏïàÎÇ¥ -->
            <div class="column-guide">
              <h5>ÌïÑÏàò Ïª¨Îüº Ï†ïÎ≥¥</h5>
              <div class="columns-list">
                <div class="column-item">
                  <span class="column-name">Î©îÏùºÎ∞úÏÜ°ÏãúÍ∞Å</span>
                  <span class="column-desc"
                    >ÌîºÏã± Î©îÏùºÏùÑ Î∞úÏÜ°Ìïú ÎÇ†ÏßúÏôÄ ÏãúÍ∞Ñ (YYYY-MM-DD HH:MM:SS ÌòïÏãù)</span
                  >
                </div>
                <div class="column-item">
                  <span class="column-name">ÏàòÌñâÏãúÍ∞Å</span>
                  <span class="column-desc"
                    >ÏÇ¨Ïö©ÏûêÍ∞Ä ÌñâÎèôÏùÑ ÏàòÌñâÌïú ÎÇ†ÏßúÏôÄ ÏãúÍ∞Ñ (Îπà Í∞íÏù¥Î©¥ Î¨¥ÏùëÎãµ Ï≤òÎ¶¨)</span
                  >
                </div>
                <div class="column-item">
                  <span class="column-name">Î°úÍ∑∏Ïú†Ìòï</span>
                  <span class="column-desc"
                    >ÏÇ¨Ïö©Ïûê ÌñâÎèô Ïú†Ìòï (Ïòà: Ïä§ÌÅ¨Î¶ΩÌä∏ Ï≤®Î∂ÄÌååÏùº Ïó¥Îûå, Ïù¥Î©îÏùº Ïó¥Îûå2, ÎßÅÌÅ¨ ÌÅ¥Î¶≠)</span
                  >
                </div>
                <div class="column-item">
                  <span class="column-name">Î©îÏùºÏú†Ìòï</span>
                  <span class="column-desc"
                    >ÌîºÏã± Î©îÏùºÏùò Ï¢ÖÎ•ò (Ïòà: Ìá¥ÏßÅÏó∞Í∏à Ïö¥Ïö©, ÏÑ∏Í∏àÍ≥ÑÏÇ∞ÏÑú, Ïπ¥Ïπ¥Ïò§ÌÜ°)</span
                  >
                </div>
                <div class="column-item">
                  <span class="column-name">Ïù¥Î©îÏùº</span>
                  <span class="column-desc">ÎåÄÏÉÅ ÏÇ¨Ïö©ÏûêÏùò Ïù¥Î©îÏùº Ï£ºÏÜå</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 3Îã®Í≥Ñ: ÌååÏùº ÏóÖÎ°úÎìú -->
          <div class="upload-step" :class="{ disabled: !selectedUploadPeriod }">
            <h4>3Îã®Í≥Ñ: ÌååÏùº ÏóÖÎ°úÎìú</h4>

            <div class="file-upload-area">
              <!-- ÌååÏùº ÎìúÎ°≠Ï°¥ -->
              <div
                class="dropzone"
                :class="{ active: isDragOver }"
                @click="triggerFileSelect"
                @dragover.prevent="isDragOver = true"
                @dragleave.prevent="isDragOver = false"
                @drop.prevent="handleFileDrop"
              >
                <input
                  type="file"
                  ref="fileInput"
                  @change="handleFileSelect"
                  accept=".xlsx,.xls,.csv"
                  style="display: none"
                />

                <!-- ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ -->
                <div v-if="!selectedFile" class="upload-placeholder">
                  <div class="upload-icon">
                    <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"
                      />
                      <path
                        d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"
                      />
                    </svg>
                  </div>
                  <h4>ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî</h4>
                  <p>ÏßÄÏõê ÌòïÏãù: Excel (.xlsx, .xls), CSV (.csv)</p>
                  <p>ÏµúÎåÄ ÌÅ¨Í∏∞: 10MB</p>
                </div>

                <!-- ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ -->
                <div v-else class="file-info">
                  <div class="file-icon">
                    <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"
                      />
                    </svg>
                  </div>
                  <div class="file-details">
                    <h5>{{ selectedFile.name }}</h5>
                    <p>ÌÅ¨Í∏∞: {{ formatFileSize(selectedFile.size) }}</p>
                  </div>
                  <button @click.stop="removeSelectedFile" class="remove-file-btn">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path
                        d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"
                      />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- ÌååÏùº Í≤ÄÏ¶ù Í≤∞Í≥º -->
            <div v-if="validationWarnings.length > 0" class="validation-warnings">
              <h5>Í≤ÄÏ¶ù Í≤∞Í≥º</h5>
              <ul class="warning-list">
                <li
                  v-for="(warning, index) in validationWarnings"
                  :key="index"
                  :class="warning.includes('Ïò§Î•ò') ? 'error' : 'warning'"
                >
                  {{ warning }}
                </li>
              </ul>
            </div>

            <!-- ÏóÖÎ°úÎìú ÎØ∏Î¶¨Î≥¥Í∏∞ -->
            <div v-if="uploadPreview.length > 0" class="upload-preview">
              <h5>ÏóÖÎ°úÎìú ÎØ∏Î¶¨Î≥¥Í∏∞ ({{ uploadPreview.length }}Í±¥)</h5>

              <!-- ÌÜµÍ≥Ñ ÏöîÏïΩ -->
              <div class="preview-stats">
                <div class="stat-card">
                  <span class="stat-label">Ï¥ù Í∏∞Î°ù</span>
                  <span class="stat-value">{{ uploadPreview.length }}Í±¥</span>
                </div>
                <div class="stat-card success">
                  <span class="stat-label">ÏÑ±Í≥µ ÏòàÏÉÅ</span>
                  <span class="stat-value">{{ getSuccessCount() }}Í±¥</span>
                </div>
                <div class="stat-card failure">
                  <span class="stat-label">Ïã§Ìå® ÏòàÏÉÅ</span>
                  <span class="stat-value">{{ getFailureCount() }}Í±¥</span>
                </div>
                <div class="stat-card neutral">
                  <span class="stat-label">Î¨¥ÏùëÎãµ ÏòàÏÉÅ</span>
                  <span class="stat-value">{{ getNoResponseCount() }}Í±¥</span>
                </div>
              </div>

              <!-- ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î -->
              <div class="preview-table">
                <table>
                  <thead>
                    <tr>
                      <th>Ïù¥Î©îÏùº</th>
                      <th>Î©îÏùºÎ∞úÏÜ°ÏãúÍ∞Å</th>
                      <th>ÏàòÌñâÏãúÍ∞Å</th>
                      <th>Î°úÍ∑∏Ïú†Ìòï</th>
                      <th>Î©îÏùºÏú†Ìòï</th>
                      <th>ÏòàÏÉÅ Í≤∞Í≥º</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(record, index) in uploadPreview.slice(0, 5)" :key="index">
                      <td>{{ record.target_email }}</td>
                      <td>{{ formatDateTime(record.email_sent_time) }}</td>
                      <td>{{ formatDateTime(record.action_time) || 'Î¨¥ÏùëÎãµ' }}</td>
                      <td>{{ record.log_type || '-' }}</td>
                      <td>{{ record.mail_type || '-' }}</td>
                      <td>
                        <span class="result-badge" :class="record.predicted_result">
                          {{ getResultText(record.predicted_result) }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <p v-if="uploadPreview.length > 5" class="more-records">
                  ... Ïô∏ {{ uploadPreview.length - 5 }}Í±¥
                </p>
              </div>
            </div>
          </div>

          <!-- ÏóÖÎ°úÎìú ÏßÑÌñâ ÏÉÅÌÉú -->
          <div v-if="uploading" class="upload-progress">
            <div class="progress-bar">
              <div class="progress-fill" :style="{ width: uploadProgress + '%' }"></div>
            </div>
            <p>ÏóÖÎ°úÎìú Ï§ë... {{ uploadProgress }}%</p>
          </div>

          <!-- ÏóÖÎ°úÎìú Í≤∞Í≥º -->
          <div v-if="uploadResult" class="upload-result">
            <h5>ÏóÖÎ°úÎìú ÏôÑÎ£å</h5>
            <div class="result-summary">
              <div class="result-item success">
                <span class="result-label">ÏÑ±Í≥µ:</span>
                <span class="result-value">{{ uploadResult.success_count }}Í±¥</span>
              </div>
              <div class="result-item update" v-if="uploadResult.update_count > 0">
                <span class="result-label">ÏóÖÎç∞Ïù¥Ìä∏:</span>
                <span class="result-value">{{ uploadResult.update_count }}Í±¥</span>
              </div>
              <div class="result-item error" v-if="uploadResult.error_count > 0">
                <span class="result-label">Ïã§Ìå®:</span>
                <span class="result-value">{{ uploadResult.error_count }}Í±¥</span>
              </div>
              <div class="result-item total">
                <span class="result-label">Ï†ÑÏ≤¥:</span>
                <span class="result-value">{{ uploadResult.total_rows }}Í±¥</span>
              </div>
            </div>

            <!-- Ïò§Î•ò ÏÉÅÏÑ∏ -->
            <div v-if="uploadResult.errors && uploadResult.errors.length > 0" class="error-details">
              <h6>Ïò§Î•ò ÏÉÅÏÑ∏:</h6>
              <ul class="error-list">
                <li v-for="(error, index) in uploadResult.errors" :key="index">
                  {{ error }}
                </li>
              </ul>
            </div>
          </div>

          <!-- Î™®Îã¨ Ïï°ÏÖò Î≤ÑÌäº -->
          <div class="modal-actions">
            <button
              type="button"
              @click="closeBulkUploadModal"
              class="cancel-button"
              :disabled="uploading"
            >
              {{ uploading ? 'ÏóÖÎ°úÎìú Ï§ë...' : 'Îã´Í∏∞' }}
            </button>

            <button
              type="button"
              @click="executeUpload"
              class="upload-button"
              :disabled="!canUpload || uploading"
            >
              <svg
                v-if="uploading"
                width="16"
                height="16"
                fill="currentColor"
                viewBox="0 0 16 16"
                class="animate-spin"
              >
                <path
                  d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"
                />
                <path
                  fill-rule="evenodd"
                  d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"
                />
              </svg>
              <svg v-else width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                  d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"
                />
                <path
                  d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"
                />
              </svg>
              {{ uploading ? 'ÏóÖÎ°úÎìú Ï§ë...' : 'ÏóÖÎ°úÎìú ÏãúÏûë' }}
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ Î™®Îã¨ -->
  </div>
</template>
<script setup>
import { ref, computed, onMounted, watch } from 'vue'

// ===== Î∞òÏùëÌòï Îç∞Ïù¥ÌÑ∞ =====
const loading = ref(false)
const selectedYear = ref(new Date().getFullYear())
const selectedTrainingType = ref('')
const selectedResult = ref('')
const searchQuery = ref('')

// Í∏∞Í∞Ñ Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞
const periodStatus = ref({
  training_types: {},
})

// Í∏∞Î°ù Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞
const trainingRecords = ref([])
const filteredRecords = ref([])

// Î™®Îã¨ ÏÉÅÌÉú
const showPeriodModal = ref(false)
const showBulkUploadModal = ref(false)
const showDetailStatsModal = ref(false)
const editingPeriod = ref(null)
const saving = ref(false)

// ÏóÖÎ°úÎìú Î™®Îã¨ Í¥ÄÎ†®
const selectedFile = ref(null)
const uploadPreview = ref([])
const selectedUploadPeriod = ref('')
const availablePeriodsForUpload = ref({})
const validationWarnings = ref([])
const isDragOver = ref(false)
const uploading = ref(false)
const uploadProgress = ref(0)
const uploadResult = ref(null)

// Ìèº Îç∞Ïù¥ÌÑ∞
const periodForm = ref({
  period_id: null,
  training_year: new Date().getFullYear(),
  period_name: '',
  training_type: 'Ïù¥Î©îÏùº ÌîºÏã±',
  start_date: '',
  end_date: '',
  description: '',
  isEdit: false,
  auto_pass_setting: true,
})

const selectedPeriod = ref(null)

// Ìèº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
const isValidPeriodForm = computed(() => {
  return (
    periodForm.value.period_name.trim() &&
    periodForm.value.training_type &&
    periodForm.value.start_date &&
    periodForm.value.end_date &&
    new Date(periodForm.value.start_date) < new Date(periodForm.value.end_date)
  )
})

// ÎÇ†Ïßú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Î©îÏãúÏßÄ
const dateValidationMessage = computed(() => {
  if (!periodForm.value.start_date || !periodForm.value.end_date) {
    return ''
  }

  const startDate = new Date(periodForm.value.start_date)
  const endDate = new Date(periodForm.value.end_date)

  if (startDate >= endDate) {
    return 'Ï¢ÖÎ£åÏùºÏùÄ ÏãúÏûëÏùºÎ≥¥Îã§ Îä¶Ïñ¥Ïïº Ìï©ÎãàÎã§.'
  }

  // Í∏∞Í∞ÑÏù¥ ÎÑàÎ¨¥ ÏßßÏùÄ Í≤ΩÏö∞
  const diffDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24))
  if (diffDays < 1) {
    return 'ÌõàÎ†® Í∏∞Í∞ÑÏùÄ ÏµúÏÜå 1Ïùº Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.'
  }

  // Í∏∞Í∞ÑÏù¥ ÎÑàÎ¨¥ Í∏¥ Í≤ΩÏö∞
  if (diffDays > 365) {
    return 'ÌõàÎ†® Í∏∞Í∞ÑÏùÄ 1ÎÖÑÏùÑ Ï¥àÍ≥ºÌï† Ïàò ÏóÜÏäµÎãàÎã§.'
  }

  return ''
})

// Ï§ëÎ≥µ Í∏∞Í∞Ñ Ï≤¥ÌÅ¨
const duplicateWarning = computed(() => {
  if (
    !periodForm.value.period_name ||
    !periodForm.value.training_type ||
    !periodForm.value.training_year
  ) {
    return ''
  }

  // ÌòÑÏû¨ Í∏∞Í∞ÑÎì§ Ï§ëÏóêÏÑú Ï§ëÎ≥µ Ï≤¥ÌÅ¨
  const currentPeriods = []
  Object.values(periodStatus.value.training_types || {}).forEach((typeData) => {
    if (typeData.periods) {
      currentPeriods.push(...typeData.periods)
    }
  })

  const duplicate = currentPeriods.find((period) => {
    // ÏàòÏ†ï Ï§ëÏù∏ Í≤ΩÏö∞ ÏûêÍ∏∞ ÏûêÏã†ÏùÄ Ï†úÏô∏
    if (editingPeriod.value && period.period_id === editingPeriod.value.period_id) {
      return false
    }

    return (
      period.training_year === periodForm.value.training_year &&
      period.period_name === periodForm.value.period_name &&
      period.training_type === periodForm.value.training_type
    )
  })

  if (duplicate) {
    return `ÎèôÏùºÌïú Ïó∞ÎèÑ(${periodForm.value.training_year})Ïóê Í∞ôÏùÄ Ïù¥Î¶ÑÏùò ${periodForm.value.training_type} Í∏∞Í∞ÑÏù¥ Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï©ÎãàÎã§.`
  }

  return ''
})

// ===== Í≥ÑÏÇ∞Îêú ÏÜçÏÑ± =====
const availableYears = computed(() => {
  const currentYear = new Date().getFullYear()
  return Array.from({ length: 6 }, (_, i) => currentYear - i)
})

const trainingTypes = ['Ïù¥Î©îÏùº ÌîºÏã±', 'SMS ÌîºÏã±', 'Ï†ÑÌôî ÌîºÏã±', 'ÏõπÏÇ¨Ïù¥Ìä∏ ÌîºÏã±']

// ===== ÎùºÏù¥ÌîÑÏÇ¨Ïù¥ÌÅ¥ =====
onMounted(() => {
  loadPeriodStatus()
  loadTrainingData()
})

// ===== Îç∞Ïù¥ÌÑ∞ Î°úÎî© Î©îÏÑúÎìú =====
const loadPeriodStatus = async () => {
  loading.value = true
  try {
    const response = await fetch(`/api/phishing/admin/periods?year=${selectedYear.value}`, {
      credentials: 'include',
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const data = await response.json()

    // Îç∞Ïù¥ÌÑ∞Î•º ÍµêÏú° Í¥ÄÎ¶¨ÏôÄ ÎèôÏùºÌïú Íµ¨Ï°∞Î°ú Î≥ÄÌôò
    const trainingTypes = {}

    if (data.periods && data.periods.length > 0) {
      data.periods.forEach((typeGroup) => {
        trainingTypes[typeGroup.type_name] = {
          total_participants: typeGroup.total_participants || 0,
          total_success: typeGroup.total_success || 0,
          total_failure: typeGroup.total_failure || 0,
          periods: typeGroup.periods || [],
        }
      })
    }

    periodStatus.value = { training_types: trainingTypes }
  } catch (error) {
    console.error('Í∏∞Í∞Ñ ÏÉÅÌÉú Î°úÎî© Ïò§Î•ò:', error)
    displayToast('Í∏∞Í∞Ñ ÏÉÅÌÉúÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error')
    periodStatus.value = { training_types: {} }
  } finally {
    loading.value = false
  }
}

const loadTrainingData = async () => {
  try {
    const params = new URLSearchParams({
      year: selectedYear.value,
      ...(selectedTrainingType.value && { training_type: selectedTrainingType.value }),
      ...(selectedResult.value && { result: selectedResult.value }),
    })

    const response = await fetch(`/api/phishing/admin/records?${params}`, {
      credentials: 'include',
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const data = await response.json()
    trainingRecords.value = data.records || []
    applyFilters()
  } catch (error) {
    console.error('ÌõàÎ†® Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò:', error)
    displayToast('ÌõàÎ†® Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error')
    trainingRecords.value = []
    filteredRecords.value = []
  }
}

// ===== Í∏∞Í∞Ñ Í¥ÄÎ¶¨ Î©îÏÑúÎìú =====
const openPeriodModal = () => {
  editingPeriod.value = null
  periodForm.value = {
    training_year: selectedYear.value,
    period_name: '',
    training_type: 'Ïù¥Î©îÏùº ÌîºÏã±',
    start_date: '',
    end_date: '',
    description: '',
    auto_pass_setting: true,
  }
  showPeriodModal.value = true
}

const resetPeriodForm = () => {
  periodForm.value = {
    period_id: null,
    training_year: selectedYear.value,
    period_name: '',
    training_type: 'Ïù¥Î©îÏùº ÌîºÏã±',
    start_date: '',
    end_date: '',
    description: '',
    isEdit: false,
  }
}

/**
 * Í∏∞Í∞Ñ Ìé∏Ïßë Î™®Îã¨ Ïó¥Í∏∞
 */
const editPeriod = (period) => {
  console.log('[DEBUG] ÏàòÏ†ïÌï† Í∏∞Í∞Ñ Îç∞Ïù¥ÌÑ∞:', period)

  editingPeriod.value = period
  periodForm.value = {
    training_year: period.training_year,
    period_name: period.period_name,
    training_type: period.training_type,
    start_date: period.start_date,
    end_date: period.end_date,
    description: period.description || '',
    auto_pass_setting: period.auto_pass_setting === 1 || period.auto_pass_setting === true,
  }

  console.log('[DEBUG] ÌèºÏóê ÏÑ§Ï†ïÎêú Í∞íÎì§:', periodForm.value)
  showPeriodModal.value = true
}

/**
 * Í∏∞Í∞Ñ Ï†ÄÏû• (Ï∂îÍ∞Ä/ÏàòÏ†ï)
 */
const savePeriod = async () => {
  if (!isValidPeriodForm.value || saving.value) {
    return
  }

  // Ï§ëÎ≥µ Ï≤¥ÌÅ¨
  if (duplicateWarning.value) {
    displayToast(duplicateWarning.value, 'error')
    return
  }

  saving.value = true

  try {
    console.log('[DEBUG] Í∏∞Í∞Ñ Ï†ÄÏû• ÏöîÏ≤≠:', periodForm.value)

    const method = editingPeriod.value ? 'PUT' : 'POST'
    const url = editingPeriod.value
      ? `/api/phishing/admin/periods/${editingPeriod.value.period_id}`
      : '/api/phishing/admin/periods'

    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(periodForm.value),
    })

    const result = await response.json()
    console.log('[DEBUG] ÏÑúÎ≤Ñ ÏùëÎãµ:', result)

    if (!response.ok) {
      // ÏôÑÎ£åÎêú Í∏∞Í∞Ñ ÏàòÏ†ï Ïãú ÌäπÎ≥Ñ Ï≤òÎ¶¨
      if (result.message && result.message.includes('ÏôÑÎ£åÎêú ÌõàÎ†® Í∏∞Í∞ÑÏùÄ ÏàòÏ†ïÌï† Ïàò ÏóÜÏäµÎãàÎã§')) {
        const confirmReopen = confirm(
          `Ïù¥ Í∏∞Í∞ÑÏùÄ ÏôÑÎ£å ÏÉÅÌÉúÏûÖÎãàÎã§.\n\nÏôÑÎ£å ÏÉÅÌÉúÎ•º Ìï¥Ï†úÌïòÍ≥† ÏàòÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n` +
            `‚Äª ÏôÑÎ£å ÏÉÅÌÉú Ìï¥Ï†ú Ïãú ÏûêÎèô ÌÜµÍ≥º Ï≤òÎ¶¨Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê† Ïàò ÏûàÏäµÎãàÎã§.`,
        )

        if (confirmReopen) {
          await reopenAndEdit()
          return
        } else {
          displayToast('ÏàòÏ†ïÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 'info')
          return
        }
      }

      throw new Error(result.error || result.message || 'Ï†ÄÏû• Ïã§Ìå®')
    }

    displayToast(
      editingPeriod.value ? 'ÌõàÎ†® Í∏∞Í∞ÑÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.' : 'ÌõàÎ†® Í∏∞Í∞ÑÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.',
      'success',
    )

    closePeriodModal()
    await loadPeriodStatus() // Í∏∞Í∞Ñ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
  } catch (error) {
    console.error('Í∏∞Í∞Ñ Ï†ÄÏû• Ïò§Î•ò:', error)
    displayToast(error.message, 'error')
  } finally {
    saving.value = false
  }
}

/**
 * Í∏∞Í∞Ñ Ïû¨Í∞ú ÌõÑ ÏàòÏ†ï
 */
const reopenAndEdit = async () => {
  try {
    // Î®ºÏ†Ä Í∏∞Í∞Ñ Ïû¨Í∞ú
    const reopenResponse = await fetch(
      `/api/phishing/admin/periods/${editingPeriod.value.period_id}/reopen`,
      {
        method: 'POST',
        credentials: 'include',
      },
    )

    if (!reopenResponse.ok) {
      const reopenResult = await reopenResponse.json()
      throw new Error(reopenResult.error || 'Í∏∞Í∞Ñ Ïû¨Í∞ú Ïã§Ìå®')
    }

    // Ïû¨Í∞ú ÌõÑ ÏàòÏ†ï ÏßÑÌñâ
    const updateResponse = await fetch(
      `/api/phishing/admin/periods/${editingPeriod.value.period_id}`,
      {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(periodForm.value),
      },
    )

    if (!updateResponse.ok) {
      const updateResult = await updateResponse.json()
      throw new Error(updateResult.error || 'ÏàòÏ†ï Ïã§Ìå®')
    }

    displayToast('Í∏∞Í∞ÑÏù¥ Ïû¨Í∞úÎêòÍ≥† ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success')
    closePeriodModal()
    await loadPeriodStatus()
  } catch (error) {
    console.error('Ïû¨Í∞ú ÌõÑ ÏàòÏ†ï Ïò§Î•ò:', error)
    displayToast(error.message, 'error')
  }
}

const completePeriod = async (period) => {
  if (!confirm(`"${period.period_name}" Í∏∞Í∞ÑÏùÑ ÏôÑÎ£å Ï≤òÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
    return
  }

  try {
    const response = await fetch(`/api/phishing/admin/periods/${period.period_id}/complete`, {
      method: 'POST',
      credentials: 'include',
    })

    if (!response.ok) {
      const errorData = await response.json()
      throw new Error(errorData.error || 'ÏôÑÎ£å Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
    }

    displayToast('Í∏∞Í∞ÑÏù¥ ÏôÑÎ£å Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.', 'success')
    await loadPeriodStatus()
  } catch (error) {
    console.error('Í∏∞Í∞Ñ ÏôÑÎ£å Ïò§Î•ò:', error)
    displayToast(error.message, 'error')
  }
}

const reopenPeriod = async (period) => {
  if (!confirm(`"${period.period_name}" Í∏∞Í∞ÑÏùÑ Ïû¨Í∞úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
    return
  }

  try {
    const response = await fetch(`/api/phishing/admin/periods/${period.period_id}/reopen`, {
      method: 'POST',
      credentials: 'include',
    })

    if (!response.ok) {
      const errorData = await response.json()
      throw new Error(errorData.error || 'Ïû¨Í∞ú Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
    }

    displayToast('Í∏∞Í∞ÑÏù¥ Ïû¨Í∞úÎêòÏóàÏäµÎãàÎã§.', 'success')
    await loadPeriodStatus()
  } catch (error) {
    console.error('Í∏∞Í∞Ñ Ïû¨Í∞ú Ïò§Î•ò:', error)
    displayToast(error.message, 'error')
  }
}

const deletePeriod = async (period) => {
  if (
    !confirm(`"${period.period_name}" Í∏∞Í∞ÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÍ¥ÄÎ†®Îêú Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§.`)
  ) {
    return
  }

  try {
    const response = await fetch(`/api/phishing/admin/periods/${period.period_id}`, {
      method: 'DELETE',
      credentials: 'include',
    })

    if (!response.ok) {
      const errorData = await response.json()
      throw new Error(errorData.error || 'ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
    }

    displayToast('Í∏∞Í∞ÑÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success')
    await loadPeriodStatus()
  } catch (error) {
    console.error('Í∏∞Í∞Ñ ÏÇ≠Ï†ú Ïò§Î•ò:', error)
    displayToast(error.message, 'error')
  }
}

// ===== ÏóÖÎ°úÎìú Í¥ÄÎ¶¨ =====
const openUploadModal = (period) => {
  selectedPeriod.value = period
  showBulkUploadModal.value = true
}

// ===== ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ =====
const viewDetailStats = (period) => {
  selectedPeriod.value = period
  showDetailStatsModal.value = true
}

// ===== ÌïÑÌÑ∞ÎßÅ =====
const applyFilters = () => {
  let filtered = trainingRecords.value

  // Í≤ÄÏÉâÏñ¥ ÌïÑÌÑ∞
  if (searchQuery.value.trim()) {
    const query = searchQuery.value.toLowerCase()
    filtered = filtered.filter(
      (record) =>
        record.username?.toLowerCase().includes(query) ||
        record.department?.toLowerCase().includes(query) ||
        record.email?.toLowerCase().includes(query),
    )
  }

  filteredRecords.value = filtered
}

const searchTrainingData = () => {
  applyFilters()
}

// ===== ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú =====
const downloadTemplate = async () => {
  try {
    const response = await fetch('/api/phishing/admin/template/download', {
      credentials: 'include',
    })

    if (!response.ok) throw new Error('ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú Ïã§Ìå®')

    const blob = await response.blob()
    const url = window.URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = 'ÌîºÏã±ÌõàÎ†®_ÏóÖÎ°úÎìú_ÌÖúÌîåÎ¶ø.csv'
    document.body.appendChild(a)
    a.click()
    window.URL.revokeObjectURL(url)
    document.body.removeChild(a)

    displayToast('ÌÖúÌîåÎ¶øÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.', 'success')
  } catch (error) {
    console.error('ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú Ïò§Î•ò:', error)
    displayToast('ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error')
  }
}

/**
 * Í∏∞Í∞Ñ Î™®Îã¨ Îã´Í∏∞
 */
const closePeriodModal = () => {
  showPeriodModal.value = false
  editingPeriod.value = null
  saving.value = false

  // Ìèº Ï¥àÍ∏∞Ìôî
  periodForm.value = {
    training_year: selectedYear.value,
    period_name: '',
    training_type: 'Ïù¥Î©îÏùº ÌîºÏã±',
    start_date: '',
    end_date: '',
    description: '',
    auto_pass_setting: true,
  }
}

const closeBulkUploadModal = () => {
  showBulkUploadModal.value = false
  selectedPeriod.value = null
}

const closeDetailStatsModal = () => {
  showDetailStatsModal.value = false
  selectedPeriod.value = null
}

// ===== Ïú†Ìã∏Î¶¨Ìã∞ Î©îÏÑúÎìú =====

/**
 * ÏµúÏÜå ÎÇ†Ïßú Í≥ÑÏÇ∞ (Ïò§Îäò ÎòêÎäî Í≥ºÍ±∞ Îç∞Ïù¥ÌÑ∞ ÌóàÏö©)
 */
const getMinDate = () => {
  // Í≥ºÍ±∞ Îç∞Ïù¥ÌÑ∞ÎèÑ ÏûÖÎ†•Ìï† Ïàò ÏûàÎèÑÎ°ù 1ÎÖÑ Ï†ÑÎ∂ÄÌÑ∞ ÌóàÏö©
  const oneYearAgo = new Date()
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1)
  return oneYearAgo.toISOString().split('T')[0]
}

/**
 * Í∏∞Í∞Ñ ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Î∞òÌôò
 */
const getPeriodStatusText = (period) => {
  if (period.is_completed) return 'ÏôÑÎ£åÎê®'

  const today = new Date()
  const startDate = new Date(period.start_date)
  const endDate = new Date(period.end_date)

  if (today < startDate) return 'ÏòàÏ†ïÎê®'
  if (today >= startDate && today <= endDate) return 'ÏßÑÌñâÏ§ë'
  if (today > endDate) return 'Ï¢ÖÎ£åÎê®'

  return 'ÏÑ§Ï†ïÎê®'
}

const formatDate = (dateString) => {
  if (!dateString) return '-'
  try {
    return new Date(dateString).toLocaleDateString('ko-KR')
  } catch {
    return dateString
  }
}

const formatDateRange = (startDate, endDate) => {
  const start = formatDate(startDate)
  const end = formatDate(endDate)
  return `${start} ~ ${end}`
}

const getTypeSuccessRate = (typeData) => {
  if (typeData.total_participants === 0) return 0
  return Math.round((typeData.total_success / typeData.total_participants) * 100)
}

const getRateClass = (rate) => {
  if (rate >= 90) return 'rate-excellent'
  if (rate >= 80) return 'rate-good'
  if (rate >= 70) return 'rate-warning'
  return 'rate-poor'
}

const getCardHeaderStatusClass = (status) => {
  const statusMap = {
    ÏôÑÎ£åÎê®: 'card-status-completed',
    ÏßÑÌñâÏ§ë: 'card-status-in-progress',
    ÏòàÏ†ïÎê®: 'card-status-not-started',
    Ï¢ÖÎ£åÎê®: 'card-status-expired',
    ÏÑ§Ï†ïÎê®: 'card-status-default',
  }
  return statusMap[status] || 'card-status-unknown'
}

// ===== ÏïåÎ¶º ÏãúÏä§ÌÖú =====
const displayToast = (message, type = 'success') => {
  // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî toast ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÇ¨Ïö©
  if (type === 'error') {
    alert(`Ïò§Î•ò: ${message}`)
  } else {
    alert(message)
  }
}

// ===== Í∞êÏãúÏûê =====
watch(selectedYear, () => {
  loadPeriodStatus()
  loadTrainingData()
})

watch([selectedTrainingType, selectedResult], () => {
  loadTrainingData()
})

// ÏãúÏûëÏùº Î≥ÄÍ≤Ω Ïãú Ï¢ÖÎ£åÏùº ÏµúÏÜåÍ∞í ÏóÖÎç∞Ïù¥Ìä∏
watch(
  () => periodForm.value.start_date,
  (newStartDate) => {
    if (newStartDate && periodForm.value.end_date) {
      const startDate = new Date(newStartDate)
      const endDate = new Date(periodForm.value.end_date)

      // Ï¢ÖÎ£åÏùºÏù¥ ÏãúÏûëÏùºÎ≥¥Îã§ Ïù¥Ï†ÑÏù¥Î©¥ ÏãúÏûëÏùº Îã§ÏùåÎÇ†Î°ú ÏÑ§Ï†ï
      if (endDate <= startDate) {
        const nextDay = new Date(startDate)
        nextDay.setDate(nextDay.getDate() + 1)
        periodForm.value.end_date = nextDay.toISOString().split('T')[0]
      }
    }
  },
)

// ÌõàÎ†® Ïú†Ìòï Î≥ÄÍ≤Ω Ïãú Í∏∞Í∞ÑÎ™Ö ÏûêÎèô Ï†úÏïà
watch(
  () => periodForm.value.training_type,
  (newType) => {
    if (!editingPeriod.value && newType) {
      // ÏÉà Í∏∞Í∞Ñ ÏÉùÏÑ± ÏãúÏóêÎßå ÏûêÎèô Ï†úÏïà
      const existingPeriods = []
      Object.values(periodStatus.value.training_types || {}).forEach((typeData) => {
        if (typeData.periods) {
          existingPeriods.push(...typeData.periods.filter((p) => p.training_type === newType))
        }
      })

      const nextNumber = existingPeriods.length + 1
      const suggestedName = `${nextNumber}Ï∞® ${newType} ÌõàÎ†®`

      if (!periodForm.value.period_name) {
        periodForm.value.period_name = suggestedName
      }
    }
  },
)
</script>

<style scoped>
@import '../styles/AdminPhishingTrainingManagement.css';
</style>
